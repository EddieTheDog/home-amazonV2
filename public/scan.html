<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scan - Home Amazon V2</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { padding: 10px; margin: 5px; }
  </style>
</head>
<body>
  <h1>Scan Package</h1>
  <div>
    <label>Session Key: <input type="text" id="sessionKey" placeholder="A1" /></label>
    <label>Device Name: <input type="text" id="deviceName" placeholder="Phone 1" /></label>
    <button id="connectSession">Connect Session</button>
  </div>

  <video id="preview" width="300" height="200" style="display:none;"></video>
  <p id="status"></p>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script>
    let sessionKey = '';
    let deviceName = '';
    let connected = false;
    let scanning = false;

    document.getElementById('connectSession').addEventListener('click', () => {
      sessionKey = document.getElementById('sessionKey').value.trim();
      deviceName = document.getElementById('deviceName').value.trim();
      if (!sessionKey || !deviceName) { alert("Fill session key and device name"); return; }
      connected = true;
      alert("Connected to session! Start scanning now.");
      startScanner();
    });

    function startScanner() {
      const html5QrcodeScanner = new Html5Qrcode("preview");
      document.getElementById("preview").style.display = "block";

      html5QrcodeScanner.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: 250
        },
        async (decodedText, decodedResult) => {
          if (!connected) return;

          // Send scan to server
          try {
            await fetch('/api/package/scan', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                sessionKey,
                barcode: decodedText,
                action: "scanned",
                location: "Warehouse",
                employee: deviceName
              })
            });
            document.getElementById('status').textContent = "Scanned: " + decodedText;
          } catch (err) {
            document.getElementById('status').textContent = "Error sending scan";
          }

          // Pause scanning for 1.5 sec cooldown
          html5QrcodeScanner.pause(true);
          setTimeout(() => html5QrcodeScanner.resume(), 1500);
        },
        (errorMessage) => { console.warn(errorMessage); }
      ).catch(err => console.error(err));
    }
  </script>
</body>
</html>
