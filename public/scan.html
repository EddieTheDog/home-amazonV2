<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Warehouse - Phone Scan</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { color: #333; }
label { display: block; margin: 8px 0; }
input { padding: 5px; width: 200px; margin-bottom: 5px; }
button { padding: 6px 12px; margin-bottom: 10px; }
#status { font-weight: bold; margin-bottom: 10px; }
#reader { width: 300px; margin-top: 20px; }
#result { background: #f5f5f5; padding: 10px; margin-top: 10px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
</style>
</head>
<body>
<h1>Warehouse - Phone Scan</h1>

<label>Session ID: <input type="text" id="sessionKey"></label>
<button id="connectSession">Connect Session</button>
<div id="status">Not connected</div>
<div id="reader"></div>
<pre id="result">Waiting for session...</pre>

<script>
let sessionKey = null;
let connected = false;

document.getElementById('connectSession').addEventListener('click', async () => {
  sessionKey = document.getElementById('sessionKey').value.trim();
  if(!sessionKey) return alert("Enter a session ID");

  // Check if session exists
  const check = await fetch(`/api/session/${sessionKey}/scans`);
  if(!check.ok) return alert("Session does not exist or ended");

  connected = true;
  document.getElementById('status').textContent = `Connected to session ${sessionKey}`;
  document.getElementById('result').textContent = "Scan packages now.";

  new Html5Qrcode("reader").start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    async decodedText => {
      if(!connected) return;
      const res = await fetch('/api/package/scan', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          sessionKey,
          barcode: decodedText,
          action: 'scanned',
          location: 'Warehouse Scan',
          employee: 'Phone Scanner'
        })
      });
      const json = await res.json();
      const resultEl = document.getElementById('result');
      resultEl.textContent = `Scanned: ${decodedText}\nStatus: ${json.package?.currentPublicStatus || 'Error'}\nTime: ${new Date().toLocaleTimeString()}\n\n` + resultEl.textContent;
    }
  );
});
</script>
</body>
</html>
