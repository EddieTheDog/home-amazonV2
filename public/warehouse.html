<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Warehouse</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .log { max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    button { margin: 5px; padding: 8px 12px; }
    #status { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Warehouse - Laptop</h1>

  <label>Session Name: <input type="text" id="sessionName" placeholder="A1"></label>
  <label>Employee Name: <input type="text" id="employeeName" placeholder="John"></label>
  <label>Location: <input type="text" id="locationName" placeholder="Warehouse 1"></label>
  <button id="startSessionBtn">Generate/Start Session</button>
  <button id="connectDeviceBtn" disabled>Connect Device</button>
  <button id="startScanBtn" disabled>Start Scanning</button>
  <button id="stopScanBtn" disabled>Stop Scanning</button>

  <div id="status">Waiting for device connection...</div>

  <div class="log" id="scanLog"></div>

  <script>
    let sessionKey = '';
    let deviceConnected = false;
    let scanning = false;
    let lastScanTime = 0;
    const cooldown = 1500; // 1.5 sec cooldown

    const scanLog = document.getElementById('scanLog');
    const statusEl = document.getElementById('status');

    document.getElementById('startSessionBtn').addEventListener('click', () => {
      const name = document.getElementById('sessionName').value || Math.random().toString(36).substring(2,4).toUpperCase();
      sessionKey = name;
      alert(`Session generated: ${sessionKey}`);
      document.getElementById('connectDeviceBtn').disabled = false;
    });

    document.getElementById('connectDeviceBtn').addEventListener('click', () => {
      if(!sessionKey) return alert('Create a session first!');
      // Simple confirm popup for device connection
      if(confirm('Device connected! Click OK to start scanning.')) {
        deviceConnected = true;
        statusEl.textContent = 'Device connected. Ready to scan.';
        document.getElementById('startScanBtn').disabled = false;
      }
    });

    document.getElementById('startScanBtn').addEventListener('click', () => {
      if(!deviceConnected) return alert('No device connected!');
      scanning = true;
      statusEl.textContent = 'Scanning started...';
      document.getElementById('stopScanBtn').disabled = false;
      document.getElementById('startScanBtn').disabled = true;
    });

    document.getElementById('stopScanBtn').addEventListener('click', () => {
      scanning = false;
      statusEl.textContent = 'Scanning paused.';
      document.getElementById('startScanBtn').disabled = false;
      document.getElementById('stopScanBtn').disabled = true;
    });

    // Poll server for new scans
    async function fetchScans() {
      if(!sessionKey) return;
      const res = await fetch(`/api/package/session-scans/${sessionKey}`);
      if(!res.ok) return;
      const scans = await res.json();
      scanLog.innerHTML = '';
      scans.forEach(pkg => {
        scanLog.innerHTML += `<div>
          <strong>Scanned:</strong> ${pkg.packageId} |
          <strong>Tracking:</strong> ${pkg.trackingNumber} |
          <strong>Status:</strong> ${pkg.currentPublicStatus} |
          <strong>Customer:</strong> ${pkg.customerName} |
          <strong>Recipient:</strong> ${pkg.recipientName} |
          <strong>Destination:</strong> ${pkg.destination} |
          <strong>Time:</strong> ${new Date(pkg.checkpoints[pkg.checkpoints.length-1].timestamp).toLocaleTimeString()}
        </div>`;
      });
    }

    setInterval(fetchScans, 1500);
  </script>
</body>
</html>
