<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Warehouse - Home Amazon V2</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #scans { margin-top: 20px; max-height: 400px; overflow-y: auto; }
    .scan-entry { padding: 10px; border-bottom: 1px solid #ccc; }
    button { margin: 5px; padding: 10px; }
  </style>
</head>
<body>
  <h1>Warehouse Dashboard</h1>

  <div>
    <label>Session Key: <input type="text" id="sessionKey" placeholder="A1" /></label>
    <label>Employee Name: <input type="text" id="employeeName" placeholder="John" /></label>
    <label>Location: <input type="text" id="location" placeholder="Warehouse 1" /></label>
    <button id="createSession">Create Session</button>
  </div>

  <div id="connectionDiv" style="display:none; margin-top:20px;">
    <p id="connectionStatus">Waiting for device connection...</p>
    <button id="confirmConnection">OK</button>
    <button id="startScanning">Start Scanning</button>
    <button id="stopScanning">Stop Scanning</button>
  </div>

  <h2>Scanned Packages</h2>
  <div id="scans"></div>

  <script>
    let sessionKey = '';
    let scanning = false;
    let connected = false;
    const scannedSet = new Set(); // cooldown to prevent duplicates

    document.getElementById('createSession').addEventListener('click', () => {
      const keyInput = document.getElementById('sessionKey').value.trim();
      const employee = document.getElementById('employeeName').value.trim();
      const location = document.getElementById('location').value.trim();
      if (!keyInput || !employee || !location) {
        alert("Please fill in session key, employee, and location.");
        return;
      }
      sessionKey = keyInput;
      document.getElementById('connectionDiv').style.display = 'block';
      document.getElementById('connectionStatus').textContent = "Device connected! Hit OK to continue.";
    });

    document.getElementById('confirmConnection').addEventListener('click', () => {
      connected = true;
      alert('Device confirmed. You can now start scanning.');
    });

    document.getElementById('startScanning').addEventListener('click', () => {
      if (!connected) { alert("Connect device first."); return; }
      scanning = true;
      alert("Scanning started!");
    });

    document.getElementById('stopScanning').addEventListener('click', () => {
      scanning = false;
      alert("Scanning stopped!");
    });

    // Poll server for new scans every 1.5 sec
    async function fetchScans() {
      if (!sessionKey || !scanning) return;
      try {
        const res = await fetch(`/api/package/updates?sessionKey=${sessionKey}`);
        const data = await res.json();
        data.forEach(pkg => {
          if (!scannedSet.has(pkg.packageId)) {
            scannedSet.add(pkg.packageId);
            const div = document.createElement('div');
            div.className = 'scan-entry';
            div.innerHTML = `
              <strong>Scanned:</strong> ${pkg.packageId} <br/>
              <strong>Tracking:</strong> ${pkg.trackingNumber} <br/>
              <strong>Customer:</strong> ${pkg.customerName} <br/>
              <strong>Recipient:</strong> ${pkg.recipientName} <br/>
              <strong>Destination:</strong> ${pkg.destination} <br/>
              <strong>Status:</strong> ${pkg.currentPublicStatus} <br/>
              <strong>Time:</strong> ${new Date(pkg.checkpoints[pkg.checkpoints.length-1].timestamp).toLocaleTimeString()}
            `;
            document.getElementById('scans').prepend(div);
          }
        });
      } catch (e) { console.error(e); }
    }

    setInterval(fetchScans, 1500);
  </script>
</body>
</html>
